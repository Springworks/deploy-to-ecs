'use strict';

var child_process = require('child_process');
var request = require('request');

var deployment_advisor = require('./deployment-advisor');
var deployment_recorder = require('./deployment-recorder');
var git_service = require('./git/git-service');
var slack_notifier = require('./slack/slack-notifier');
var webhook_notifier = require('./http/webhook-notifier');
var configurator = require('./configurator');

exports.create = function (process_env) {
  var config = configurator.create(process_env);
  var git_service_instance = git_service.create(child_process);
  var slack_notifier_instance = slack_notifier.create(config.slack.webhook_url, config.slack.username, config.slack.channel);
  var webhook_notifier_instance = webhook_notifier.create(request, config.webhook.url, config.webhook.basic_auth);

  var advisor = deployment_advisor.create(git_service_instance, slack_notifier_instance);
  var recorder = deployment_recorder.create(git_service_instance, slack_notifier_instance, webhook_notifier_instance);

  return {
    suggestDeployment: advisor.suggestDeployment,
    recordDeployment: recorder.recordDeployment
  };
};