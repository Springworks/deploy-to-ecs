#!/usr/bin/env node
'use strict';

/* eslint no-process-exit: 0 */
const update_service = require('./update-service');
const fs = require('fs');
const path = require('path');

let configuration_file_name = 'deploy.json';

if (process.argv[2] === undefined) {
  process.stdout.write('ecs-deployer requires at least one argument.\n\n');
  process.stdout.write('Usage: ecs-deployer <image tag>\n');
  process.exit(1);
}

if (process.argv[3] !== undefined) {
  configuration_file_name = process.argv[3];
}

const config_file_path = path.join(process.cwd(), configuration_file_name);

fs.access(config_file_path, (fs.constants || fs).R_OK, err => {
  if (err) {
    if (err.code === 'ENOENT') {
      process.stdout.write(`ecs-deployer requires a configuration file, ${configuration_file_name}, see https://github.com/Springworks/node-ecs-deployer#readme.\n\n`);
      process.stdout.write('Usage: ecs-deployer <image tag>\n');
    }
    process.exit(1);
  }
  update_service.deploy({ image_tag: process.argv[2], configuration_file_name }).catch(deploy_err => {
    process.stderr.write(`ecs-deployer failed: ${JSON.stringify(deploy_err, null, 2)} \n\n`);
    process.exit(1);
  });
});