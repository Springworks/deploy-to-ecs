# node-ecs-deployer
Deploys a new image with the specified image tag to an ECS service. 

If the specified service doesn't exists, it will be created automatically using the provided configuration.

If the task definition family doesn't exist it will be created automatically using the provided configuration.

The script currently doesn't support services that uses ELB's and only updates the first container definition's image.

## Usage

### Local execution

`AWS_REGION=<region> node . <image_tag>`

### Global execution

`AWS_REGION=<region> ecs-deployer <image_tag>`

### Optional configuration file name

To support different environments with build configurations, you can specify different deployment configuration file names
(defaults to `deploy.json`), as a second argument:

`AWS_REGION=<region> ecs-deployer <image_tag> production.json`

### Configuration

The application needs to have a configuration file, named **deploy.json**, with the following minimum content:

```
{
	"service": {
		"serviceName": "string",
	}
}
```
The above example assumes that the service, task-definition, repository and the image name are all named the same, and no load balancer nor external ports are exposed. 
The default values can be found in the `src/defaults/config.js` file. 

The following is an example of a configuration if application scaling is to be used with scaling based on a queue's backlog size:

```
{
  "service": {
    "serviceName": "string"
  },
  "applicationScaling": {
    "alarmsAndActions": [
      {
        "alarm": {
          "AlarmName": "my-scale-out-alarm",
          "AlarmDescription": "Alert if queue has too many visible messages",
          "MetricName": "ApproximateNumberOfMessagesVisible",
          "Namespace": "AWS/SQS",
          "Statistic": "Average",
          "Period": "60",
          "EvaluationPeriods": "1",
          "Threshold": "5",
          "ComparisonOperator": "GreaterThanThreshold",
          "Dimensions": [
            {
              "Name": "QueueName",
              "Value": "roadside_assistance_vehicle_position"
            }
          ]
        }, 
        "policy": {
          "PolicyName": "serviceScaleOutPolicy",
          "PolicyType": "StepScaling",
          "StepScalingPolicyConfiguration": {
            "AdjustmentType": "ChangeInCapacity",
            "Cooldown": 60,
            "MetricAggregationType": "Average",
            "StepAdjustments": [
              {
                "ScalingAdjustment": 1,
                "MetricIntervalLowerBound": 0,
                "MetricIntervalUpperBound": 50
              },
              {
                "ScalingAdjustment": 2,
                "MetricIntervalLowerBound": 50,
                "MetricIntervalUpperBound": 200
              },
              {
                "ScalingAdjustment": 4,
                "MetricIntervalLowerBound": 200,
                "MetricIntervalUpperBound": 1000
              },
              {
                "ScalingAdjustment": 8,
                "MetricIntervalLowerBound": 1000,
                "MetricIntervalUpperBound": null
              }
            ]
          }
        }
      },
      {
        "alarm": {
          "AlarmName": "my-scale-in-alarm",
          "AlarmDescription": "If queue has no visible messages",
          "MetricName": "ApproximateNumberOfMessagesVisible",
          "Namespace": "AWS/SQS",
          "Statistic": "Maximum",
          "Period": "900",
          "EvaluationPeriods": "1",
          "Threshold": "1",
          "ComparisonOperator": "LessThanThreshold",
          "Dimensions": [
            {
              "Name": "QueueName",
              "Value": "roadside_assistance_vehicle_position"
            }
          ]        
        }, 
        "policy": {
          "PolicyName": "serviceScaleInPolicy",
          "PolicyType": "StepScaling",
          "StepScalingPolicyConfiguration": {
            "AdjustmentType": "ChangeInCapacity",
            "Cooldown": 900,
            "MetricAggregationType": "Average",
            "StepAdjustments": [
              {
                "ScalingAdjustment": -1,
                "MetricIntervalUpperBound": 0
              }
            ]
          }
        }
      }      
    ]
  }
}
```


The full configuration options you can see below. **Note!** When deploying an update, the only service properties that are taken into account are `taskDefinition` and `deploymentConfiguration`.
```
{
	"service": {
		"clientToken": "string",
		"cluster": "string",
		"deploymentConfiguration": {
			"maximumPercent": number,
			"minimumHealthyPercent": number
		},
		"desiredCount": number, /* required */
		"loadBalancers": [{
			"containerName": "string",
			"containerPort": number,
			"loadBalancerName": "string",
			"targetGroupArn": "string"
		}],
		"role": "string",
		"serviceName": "string", /* required */ 
		"taskDefinition": "string" /* required */
	},
	"taskDefinition": {
		"containerDefinitions": [{
			"command": ["string"],
			"cpu": number,
			"disableNetworking": boolean,
			"dnsSearchDomains": ["string"],
			"dnsServers": ["string"],
			"dockerLabels": {
				"string": "string"
			},
			"dockerSecurityOptions": ["string"],
			"entryPoint": ["string"],
			"environment": [{
				"name": "string",
				"value": "string"
			}],
			"essential": boolean,
			"extraHosts": [{
				"hostname": "string",
				"ipAddress": "string"
			}],
			"hostname": "string",
			"image": "string", /* required */
			"links": ["string"],
			"logConfiguration": {
				"logDriver": "string",
				"options": {
					"string": "string"
				}
			},
			"memory": number, /* required */
			"memoryReservation": number,
			"mountPoints": [{
				"containerPath": "string",
				"readOnly": boolean,
				"sourceVolume": "string"
			}],
			"name": "string", /* required */
			"portMappings": [{
				"containerPort": number,
				"hostPort": number,
				"protocol": "string"
			}],
			"privileged": boolean,
			"readonlyRootFilesystem": boolean,
			"ulimits": [{
				"hardLimit": number,
				"name": "string",
				"softLimit": number
			}],
			"user": "string",
			"volumesFrom": [{
				"readOnly": boolean,
				"sourceContainer": "string"
			}],
			"workingDirectory": "string"
		}],
		"family": "string",
		"networkMode": "string",
		"taskRoleArn": "string",
		"volumes": [{
			"host": {
				"sourcePath": "string"
			},
			"name": "string"
		}]
	},
	"applicationScaling": {
        "serviceScalingTarget": { /* see http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/ApplicationAutoScaling.html#registerScalableTarget-property for description and required values*/
           "MaxCapacity": number,
           "MinCapacity": number,
           "ResourceId": "string",
           "RoleARN": "string"
        },
        "alarmsAndActions": [{
          "alarm": {    /*see http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/CloudWatch.html#putMetricAlarm-property for description and required values*/
              "ActionsEnabled" : Boolean,
              "AlarmActions" : [ String, ... ],
              "AlarmDescription" : String,
              "AlarmName" : String,
              "ComparisonOperator" : String,
              "Dimensions" : [ Dimension, ... ],
              "EvaluateLowSampleCountPercentile" : String,
              "EvaluationPeriods" : Integer,
              "ExtendedStatistic" : String,
              "InsufficientDataActions" : [ String, ... ],
              "MetricName" : String,
              "Namespace" : String,
              "OKActions" : [ String, ... ],
              "Period" : Integer,
              "Statistic" : String,
              "Threshold" : Double,
              "TreatMissingData" : String,
              "Unit" : String          
          }
          "policy": { /*see http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/ApplicationAutoScaling.html#putScalingPolicy-property for description and required values*/
            "PolicyName": "string",
            "StepScalingPolicyConfiguration": { 
              "AdjustmentType": "string",
              "Cooldown": number,
              "MetricAggregationType": "string",
              "StepAdjustments": [ 
                { 
                  "MetricIntervalLowerBound": number,
                  "MetricIntervalUpperBound": number,
                  "ScalingAdjustment": number
                }
              ]
            }
          }
        }]
    }
	
}
```

### AWS credentials
Here are the ways you can supply your credentials in order of recommendation:

1. Loaded from AWS Identity and Access Management (IAM) roles for Amazon EC2 (if running on Amazon EC2)
2. Loaded from the shared credentials file (~/.aws/credentials)
3. Loaded from environment variables
4. Loaded from a JSON file on disk

See [Amazon's developer guide for setting credentials](http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/setting-credentials-node.html) for more information.


### Example

`AWS_REGION=eu-west-1 ecs-deployer 1.0.1`

#### deploy.json example:
```
{
    "service":{
        "desiredCount": 2,
        "serviceName": "my-app",
        "taskDefinition": "my-app" /* same as family name specified in the taskDefinition */
    },
    "taskDefinition":{
        "containerDefinitions":[
            {
                "name": "my-app",
                "image": "123456789012.dkr.ecr.eu-west-id.amazonaws.com/my-app",
                "memory": 10,
                "user": "springworks"
            }
        ],
        "family": "my-app"
    }
}
``` 
where `image` takes the form \<accountId\>.dkr.ecr.\<region\>.amazonaws.com/\<repository-name\>
